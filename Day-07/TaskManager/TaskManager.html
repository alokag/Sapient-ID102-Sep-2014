<!DOCTYPE html>
<html lang="en" data-ng-app="taskApp">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="styles/style.css">
	<script src="scripts/angular.js"></script>
	
	<script>
    angular.module("utils",[]);
    angular.module("utils").filter("trimText",function(){
        return function(data, trimLength){
            data = data || "";
            trimLength = trimLength || 10;
            return data.length <= trimLength ? data : data.substr(0,trimLength) + "...";
        }
    });
    
    angular.module("taskApp", ['utils']);
        
    angular.module("taskApp").factory('Task', function(){
        function Task(defaults){
            this.id = defaults.id || 0;
            this.name = defaults.name || "";
            this.isCompleted = defaults.isCompleted || false;
            this.createdAt = defaults.createdAt || new Date();
            this.completedAt = defaults.completedAt;
        }
        Task.prototype.toggleCompletion = function(){
            this.isCompleted = !this.isCompleted;
            this.completedAt = (this.isCompleted ? new Date() : undefined);
        }
        return Task;
    });
        
    
    angular.module("taskApp").service("taskStorage", function(Task){
        
        var storage = window.localStorage;
        
        this.getAll = function(){
            var result = [];
            for(var i=0;i<storage.length;i++){
                var key = storage.key(i);
                var dataAsString = storage.getItem(key);
                var data = window.JSON.parse(dataAsString);
                var task = new Task(data);
                result.push(task);
            }
            return result;
        };
        this.addOrUpdate = function(task){
             storage.setItem(task.id, window.JSON.stringify(task));
        };
        this.remove = function(task){
            storage.removeItem(task.id);
        }
        
    });
        
        
    
    angular.module("taskApp").controller("taskController", function ($scope, taskStorage, Task){
        $scope.tasks = taskStorage.getAll();
        $scope.sortOrder = "",
        $scope.reverse = false;
        
        $scope.setTaskToEdit=function(task){
            $scope.taskToEdit = task;
        }
        $scope.sort = function(attrName){
            if ($scope.sortOrder === attrName) {
                $scope.reverse = !$scope.reverse;
                return;
            }
            $scope.sortOrder = attrName;
            $scope.reverse = false;
        }
        
        $scope.sortStatus = function(name){
            if (name === $scope.sortOrder)
                return $scope.reverse ? "desc" : "asc";
            return "";
        }
        
        $scope.addTask = function(taskName){
            var newTask = new Task({id: new Date().getTime().toString(),name: taskName,isCompleted: false });
            taskStorage.addOrUpdate(newTask);
            $scope.tasks.push(newTask);
        }
        $scope.toggleCompletion = function(task){
            task.toggleCompletion();
            taskStorage.addOrUpdate(task);
        }
        $scope.removeCompleted = function(){
            for(var i=$scope.tasks.length-1;i>=0;i--){
                if ($scope.tasks[i].isCompleted){
                    taskStorage.remove($scope.tasks[i])
                    $scope.tasks.splice(i,1);
                }
            }
            
        }
        $scope.getTotalCount = function(){
            return $scope.tasks.length;
        };
        $scope.getCompletedCount = function(){
            var completedCount = 0;
            angular.forEach($scope.tasks, function(value){
                if (value.isCompleted)
                    ++completedCount;
            });
            return completedCount;
        };
        $scope.updateTask = function(evt){
            
            if (evt.keyCode === 13){
            
                $scope.taskToEdit = undefined;
            }
        }
    });
        
    
    </script>
</head>
<body  data-ng-controller="taskController">
	<h1>Task Manager - [<span class="completedCount">{{getCompletedCount()}}</span>/<span>{{getTotalCount()}}</span>]
</h1>
	<label for="">Search :</label><input type="search" ng-model="searchTask.name" >
	Is Completed ? : <input type="checkbox" ng-model="taskCompletionFlag" ng-click="searchTask.isCompleted = (taskCompletionFlag ? undefined : true)">
	Task Name Length : <input type="range" ng-model="taskNameLength" min="10" max="50">
	<hr>
	<div>
        
	    <label for="txtTask">Task :</label>
	    <input type="text" data-ng-model="newTask">
	    
	    <input type="button" value="Add Task" id="btnAdd" data-ng-click="addTask(newTask)">
	    <input type="button" value="Remove Completed" data-ng-click="removeCompleted()">
        <table data-ng-hide="tasks.length === 0" style="width:75%; margin-top:10px" border="1" cellpadding="5px">
            <tr>
                <th>#</th>
                <th data-ng-click="sort('name')" data-ng-class="{sortColumn : sortOrder==='name'}">
                    Name 
                    <span ng-show="'name' === sortOrder">
                        <img ng-src="icons/{{reverse?'arrow_down.png' : 'arrow_up.png'}}">
                    </span>    
                    
                </th>
                <th data-ng-click="sort('createdAt')" data-ng-class="{sortColumn : sortOrder==='createdAt'}">Created On <span ng-show="'createdAt' === sortOrder">
                        <img ng-src="icons/{{reverse?'arrow_down.png' : 'arrow_up.png'}}">
                    </span>    </th>
                <th data-ng-click="sort('isCompleted')" data-ng-class="{sortColumn : sortOrder==='isCompleted'}">Is Completed <span ng-show="'isCompleted' === sortOrder">
                        <img ng-src="icons/{{reverse?'arrow_down.png' : 'arrow_up.png'}}">
                    </span>    </th>
                <th data-ng-click="sort('completedAt')" data-ng-class="{sortColumn : sortOrder==='completedAt'}">Completed On <span ng-show="'completedAt' === sortOrder">
                        <img ng-src="icons/{{reverse?'arrow_down.png' : 'arrow_up.png'}}">
                    </span>    </th>
                <th></th>
                <th></th>
            </tr>
            <tr data-ng-repeat="task in tasks | filter:searchTask | orderBy:sortOrder:reverse">
                <td style="text-align:center">{{$index}}</td>
                <td data-ng-class="{completed: task.isCompleted, sortColumn : sortOrder==='name'}">
                <div ng-if="taskToEdit === task"  >
                    <input type="text" ng-model="task.name" ng-keypress="updateTask($event)">
                </div>
                <span ng-if="taskToEdit !== task">
                    {{task.name | trimText:taskNameLength}}    
                </span>
                </td>
                <td data-ng-class="{sortColumn : sortOrder==='createdAt'}">{{task.createdAt | date}}</td>
                <td data-ng-class="{sortColumn : sortOrder==='isCompleted'}">{{task.isCompleted}}</td>
                <td data-ng-class="{sortColumn : sortOrder==='completedAt'}">{{task.completedAt | date}}</td>
                <td><input type="button" value="Toggle Completion" data-ng-click="toggleCompletion(task)"></td>
                <td><input type="button" value="Edit" ng-click="setTaskToEdit(task)" ></td>
                <td><a href="#">Details</a></td>
            </tr>
        </table>
	         
	    
	</div>
</body>
</html>